# GitHub Actions CI/CD Pipeline Configuration

name: API Automation Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - uat
      tags:
        description: 'Tags to run (e.g., smoke, payments)'
        required: false
        default: 'smoke'

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
        environment: [qa]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” Lint with flake8
      run: |
        pip install flake8
        # Stop build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: ğŸ§ª Run smoke tests
      run: |
        behave -D env=${{ matrix.environment }} --tags=smoke \
          -f allure_behave.formatter:AllureFormatter \
          -o reports/allure-results \
          --junit --junit-directory reports/junit
      env:
        API_TOKEN: ${{ secrets.QA_API_TOKEN }}
    
    - name: ğŸ§ª Run all tests
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        behave -D env=${{ matrix.environment }} \
          -f allure_behave.formatter:AllureFormatter \
          -o reports/allure-results \
          --junit --junit-directory reports/junit
      continue-on-error: true
    
    - name: ğŸ“Š Generate Allure Report
      if: always()
      uses: simple-elf/allure-report-action@master
      with:
        allure_results: reports/allure-results
        allure_report: reports/allure-report
        allure_history: reports/allure-history
        keep_reports: 20
    
    - name: ğŸ“¤ Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-report-${{ matrix.environment }}-${{ matrix.python-version }}
        path: reports/allure-report
        retention-days: 30
    
    - name: ğŸ“¤ Upload Test Logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-logs-${{ matrix.environment }}-${{ matrix.python-version }}
        path: logs/
        retention-days: 30
    
    - name: ğŸ“Š Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: reports/junit/*.xml
        check_name: Test Results - ${{ matrix.environment }}
    
    - name: ğŸ’¬ Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const comment = `## ğŸ§ª Test Results
          
          **Environment:** ${{ matrix.environment }}
          **Python:** ${{ matrix.python-version }}
          
          [View Allure Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ“§ Notify on failure
      if: failure() && github.event_name == 'push'
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'API Tests failed in ${{ matrix.environment }} environment'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  deploy-reports:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¥ Download Allure Report
      uses: actions/download-artifact@v3
      with:
        name: allure-report-qa-3.10
        path: reports/allure-report
    
    - name: ğŸš€ Deploy to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: reports/allure-report
        destination_dir: reports/${{ github.run_number }}
